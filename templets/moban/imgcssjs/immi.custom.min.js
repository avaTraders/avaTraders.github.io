jQuery(document).ready(function ($) {

    /** jQuery to drive arrow navigation of the tree-menu.
	* The collapse/expand functionality is already provided by _collapsible.js.
	*/
    $('.vMenu').each(function () {

        var tree = this,
			$tree = $(this),
			newFocus = function (focus, offset) {
			    var allLinks = jQuery.makeArray($('a:visible', tree)),
					newFocus = null;
			    // TODO There must be a more efficient way to do this.
			    for (var focusIndex = allLinks.length - 1; focusIndex >= 0; --focusIndex) {
			        if (allLinks[focusIndex] === focus) {
			            newFocus = allLinks[(focusIndex + offset + allLinks.length) % allLinks.length];
			            break;
			        }
			    }
			    return newFocus;
			};
			
			
			
			
			

        // bind event handlers
        $tree.bind('keydown', function (event) {
            if (event.which == 40) { // down arrow
                event.preventDefault();
                var focus = $('[tabindex="0"]', tree).get(0); // Using $focus rather than focus doesn't seem to work
                $(focus).attr('tabindex', '-1');
                focus = newFocus(focus, 1);
                $(focus).attr('tabindex', '0');
                $(focus).focus();
            }
            else if (event.which == 38) { // up arrow
                event.preventDefault();
                var focus = $('[tabindex="0"]', tree).get(0); // Using $focus rather than focus doesn't seem to work
                $(focus).attr('tabindex', '-1');
                focus = newFocus(focus, -1);
                $(focus).attr('tabindex', '0');
                $(focus).focus();
            }
        });
		
		
        $('.collapsible > a', tree).bind('click', function (event) {
            // Move keyboard focus to a submenu trigger when it is mouse clicked.
            event.preventDefault();
            $('[tabindex="0"]', tree).attr('tabindex', '-1');
            $(this).attr('tabindex', '0');
        });
		

    });
	
	
	
	$("ul.mega-menu ul li:first-child").addClass("hover");
	$("ul.mega-menu ul li").hover(function(){
		$(this).siblings("li").removeClass("hover");
		//$("ul.mega-menu ul li").removeClass("hover");
		$(this).addClass("hover");
		});
	
	

});

//Create date picker function
function createDatePicker() {
    $(".datepicker").datepicker({
        dateFormat: "dd/mm/yy",
        showOn: "both",
        buttonImageOnly: true,
        buttonImage: "/Style%20Library/images/icon-calendar.jpg",
        buttonText: "Calendar",
        minDate: "-1Y",
        maxDate: "+1Y"
    })
    $(".ui-datepicker-trigger").attr("title", "");
}


(function (a, b) { function d(a) { if (a.keyCode === 9) { var b = !!a.shiftKey; e(this, a.target, b) && (a.preventDefault(), a.stopPropagation()) } } function e(a, b, c) { var d = i(a), e = b, f, g, h, j; do { f = d.index(e), g = f + 1, h = f - 1, j = d.length - 1; switch (f) { case -1: return !1; case 0: h = j; break; case j: g = 0 } c && (g = h), e = d.get(g); try { e.focus() } catch (k) { } } while (b === b.ownerDocument.activeElement); return !0 } function f() { return this.tabIndex > 0 } function g() { return !this.tabIndex } function h(a, b) { return a.t - b.t || a.i - b.i } function i(b) { var c = a(b), d = [], e = 0; return m.enable && m.enable(), c.find("a[href], link[href], [draggable=true], [contenteditable=true], :input:enabled, [tabindex=0]").filter(":visible").filter(g).each(function (a, b) { d.push({ v: b, t: 0, i: e++ }) }), c.find("[tabindex]").filter(":visible").filter(f).each(function (a, b) { d.push({ v: b, t: b.tabIndex, i: e++ }) }), m.disable && m.disable(), d = a.map(d.sort(h), function (a) { return a.v }), a(d) } function j() { return this.keydown(d), this.data(c, !0), this } function k() { return this.unbind("keydown", d), this.removeData(c), this } function l() { return !!this.data(c) } var c = "trap.isTrapping"; a.fn.extend({ trap: j, untrap: k, isTrapping: l }); var m = {}; a.find.find && a.find.attr !== a.attr && function () { function e(a) { var d = a.getAttributeNode(c); return d && d.specified ? parseInt(d.value, 10) : b } function f() { d[c] = d.tabIndex = e } function g() { delete d[c], delete d.tabIndex } var c = "tabindex", d = a.expr.attrHandle; m = { enable: f, disable: g } }() })(jQuery);

$(document).ready(function () {

    var countrySelect = $('#country-select-link')
    var countrySelectOffset = countrySelect.offset();
    var country ="China";
    var countryFlag = "Flag of " + country;

    countrySelect.click(function (event) {
        event.preventDefault();
    });

    createTabs("h2");

    $(".immi-tabset .tabbody").each(function () {
        createTwisties(this, "h3", 1);
    });

    $("div.expandable").each(function () {
        createTwisties(this, "h2", 2);
    });
    $("div.expandable").each(function () {
        createTwisties(this, "h3", 2);
    });
    $("div.expandable").each(function () {
        createTwisties(this, "h4", 2);
    });
    $("div.expandable-h2").each(function () {
        createTwisties(this, "h2", 2);
    });
    $("div.expandable-h3").each(function () {
        createTwisties(this, "h3", 2);
    });
    $("div.expandable-h4").each(function () {
        createTwisties(this, "h4", 2);
    });

    //Country select modal
    function createDialog(id, target) {
        $(id).dialog({
            minHeight: 350,
            minWidth: 270,
            position: {
                my: "left top",
                at: "left top",
                of: target
            },
            close: function (e) {
                $('#select_country a:first').focus()
            },
            open: function (e) {
                $('.ui-widget-overlay').hide().fadeIn();

            },
            autoOpen: false,
            describedBy: "dialogDescription",
            modal: true,
            dialogClass: "immi-popover immi-country-modal",
            resizable: false,
            show: { effect: 'slideDown', speed: 500 },
            hide: { effect: 'slideUp', speed: 500 },
            appendTo: "body form:first"
        });
        $('#select_country a:first').click(function () {
            $("#country-select-modal").dialog("open")
                .find(":input").eq(0).focus();
            return false;
        });
        $(id).bind("clickoutside", function (event) {
            $(this).dialog("close");
        });
    }
    //Add country attributes to the country select elements


    createDatePicker();
    function createTabs(h) {
        var ul = $('<ul>');
        // check if the page wants the tabs to be tagged by coremetrics
        var $isToTag = $("div[data-an-includetabs] .immi-tabset")[0];
        if ($isToTag != undefined) {
            ul.attr("data-an-category", "ImmiTabset");
            ul.attr("data-an-addpagename", "true");
        }
        $(".immi-tabset " + h).each(function (i) {
            var li = $("<li>");
            $(this).next().attr("id", "tab-content-" + i)
            $(li).append("<a href='#tab-content-" + i + "'>" + $(this).html() + "</a>");
            $(ul).append(li);
            $(this).addClass("accessibletabsanchor");
        });
        $(".immi-tabset").prepend(ul);
        
        $(".immi-tabset ul li a").css('height', $(".immi-tabset ul li").height() - 10);
    }


    try {
        //expand a page heading by getting the url parameter "heading"
        $("#" + getParameterByName("heading")).parent().toggleClass("collapsed").toggleClass("expanded").next().slideToggle().parent().focus();
        $('html, body').animate({
            scrollTop: $("#" + getParameterByName("heading")).offset().top - 50
        }, 1000);
    }
    catch (e) {
    }

    $(".image-animation-control").click(function () {
        var id = $(this).attr("href");
        var img = $(id);
        $(this).toggleClass("animation-start");
        $(this).toggleClass("animation-pause");
        if (img.attr("src") == $(this).attr("data-image-1")) {
            img.attr("src", $(this).attr("data-image-2"));
            $(this).find("span:first").html("Start animation");
            $(this).attr("title", "Start animation");

        }
        else {
            img.attr("src", $(this).attr("data-image-1"));
            $(this).find("span:first").html("Stop animation");
            $(this).attr("title", "Stop animation");
        }
        return false;
    });
    hideEmptyStreamList();
    toggleVisaFinderFields();
    $('#visaFinderPurpose select').change(function () { toggleVisaFinderFields(); });
    toggleFormFinderFields();
    $('#formFinderPurpose select').change(function () { toggleFormFinderFields(); });
    try {
        //Apply currentNode class to element with matching id
        $("#" + currentNode).addClass("currentNode");
    }
    catch (e) {
        //Process nav for the static site
        $('.vMenu .content li a').each(function () {
            if ($(this).attr("href") == window.location.pathname) {
                $(this).addClass("currentNode");
                return;
            }
        })
    }
    try {
        if (!$("body").hasClass("search")) {
            // Tree menu
            $('.vMenu .content')

                .bind("ready.jstree", function (e, data) {
                    data.instance.select_node(".currentNode", true);
                })
                .jstree({
                    plugins: ["themes", "html_data", "ui"],
                    "default": { draggable: false }
                });
        }

    }
    catch (e) {

    }
    if ($("#s4-ribbonrow")[0]) { setTopPadding(); };

    //Validation for date-picker for the estimator
    $("#ctl00_PlaceHolderMain_ProductQuestionsPanel_ProductQuestionsControl_Qn2_A").blur(function () {
        if (!checkDate($(this).val()) && $(this).val() != "") {
            alert("The date entered is not in the correct format. Format must be dd/mm/yyyy");
            $(this).val("");
            $(this).focus();

        }
    });


    try {
        $(".immi-mobile-icon-nav:first").click(function () {
            if (!$("#immi-mobile-nav").length) {
                //$("#mobile-menu-container").load("/_layouts/SP.Immi/Navigation/MobileNavigation.aspx #immi-mobile-nav", function (data) {
                //    $("#MobileNavigationControl_MobileNavigationDiv").addClass("immi-mobile-menu-wrapper");
                //    loadMobileNav();
                //    $("#MobileNavigationControl_MobileNavigationDiv").show();
                //    $(this).addClass("open");
                //})
                //$("#MobileNavigationControl_MobileNavigationDiv").addClass("immi-mobile-menu-wrapper");
                loadMobileNav("#mobile-menu-container", "/_layouts/SP.Immi/Navigation/MobileNavigation.aspx #immi-mobile-nav");
                //$("#MobileNavigationControl_MobileNavigationDiv").show();
                $(this).addClass("open");
            }
            else {
                $("#immi-mobile-nav").toggle();
            }
            $(this).toggleClass("open").toggleClass("closed");
            if ($(this).html() == "Navigation") {
                $(this).html("Close navigation");
            }
            else {
                $(this).html("Navigation");
            }

            $("body").toggleClass("mobile-nav-show");
            return false;
        })

    }
    catch (e) {
        //console.log(e + ": failed to process mobile nav.");
    }
    function loadMenu() {
        WebForm_DoPostBackWithOptions(new WebForm_PostBackOptions("ctl00$MobNav$OpenMobileNav", "", true, "", "", false, true));
    }
    //Popular visas heading
   
    var carouselPanels = 4;
    var minimumCarouselPanels = 5;
    if (window.innerWidth < 480) {
        carouselPanels = 1;
        minimumCarouselPanels = 2;
        carouselHeight = 100;
    }
    else if (window.innerWidth < 950) {
        carouselPanels = 3;
        minimumCarouselPanels = 4;

    }
    //console.log("panel: "+carouselPanels);
    $('.immi-carousel').carouFredSel({
        //circular: true,
        //infinite: false,
        items: {
            visible: carouselPanels,
            minimum: minimumCarouselPanels,
            width: 100 / carouselPanels,
            height:200
        },
        height:200,
        width:"95%",
        scroll: {
            items: 2,
            fx: "directscroll",
            duration: 600,
            easing: "easeInOutBack"
        },
        auto: {
            play: true
        },
        prev: {
            button: "#carousel_prev",
            key: "left"
        },
        next: {
            button: "#carousel_next",
            key: "right"
        },
        //pagination: "#carousel_pag",
        responsive: true,
        onCreate: function () {
        //    //$(".carousel").css("visibility", "visible");
        //    //$(".immi-carousel").css("background", "none");
        //    //$("div.pagination").css("visibility", "visible");
            $("a.next").css("visibility", "visible");
            $("a.prev").css("visibility", "visible");
        },
        swipe: {
            onTouch: true
        }
    });

    //equal height panels for 
    //if (document.width < 1156 && document.width > 780) {
    //var arr = new Array();
    //var maxHeight;
    //var panels = $('.panel-set-right .content');
    //panels.each(function () { arr.push($(this).height()) })
    //maxHeight = Math.max.apply(Math, arr);
    //panels.height(maxHeight);

    //}
    //If VisaFinderSmall control is on the page
    try {
        if (visaFinderSmall) {
            var intent = $.cookie(intentCookieKey);
            var nationality = $.cookie(nationalityCookieKey);
            var applyingFrom = $.cookie(applyingFromKey);
            $(purposeId).val(intent).attr("selected", "selected");
            $(applyFromId).val(applyingFrom).attr("selected", "selected");
            $(nationalityId).val(nationality).attr("selected", "selected");
        }
    }
    catch (e) { };

    try {
        $(cmCategoryId).change(function () {
            var str = "";
            $(cmCategoryId + " option:selected").each(function () {
                str += $(this).val() + " ";
            });
            $("#_coremetricsSelection :text").val(str);
        });
    }

    catch (e) { };

    // new homepage design slider
    $('.immi-slider-v2').bxSlider({
        auto: true,
        autoControls: true,
        controls: false,
        mode: 'fade',
        captions: true
    });

    // activate campaign slider
    $('.campaign-slider').bxSlider({
        auto: true,
        autoControls: true,
        controls: false,
        mode: 'fade',
        captions: true
    });


    // add odd class to stories block
    $('.stories-block a:odd').addClass('odd');
    $('a.external-prompt').click(function () {
        alert("You are now leaving the Department of Immigration and Border Protection website.");
    });
    $(".gallery a").colorbox({ rel: "group1", trapFocus: true });

    //Core metrics code for citz dat campaign site.
    $(".citzday").click(function () {
        cmCreateElementTag(this.text, 'citzday');
    })

    // Add alt attribute to search results pagination
    $("a#SRP_PrevImg > img").attr('alt', "Move to previous page");
    $("a#SRP_NextImg > img").attr('alt', "Move to next page");

    //Dodgy script to hide empty second side bar control boxes
    if ($("#ctl00_PlaceHolderMain_SecondSideBarControl_PopularContent__ControlWrapper_RichHtmlField").html() == "") {
        var div = $("#ctl00_PlaceHolderMain_SecondSideBarControl_PopularContent__ControlWrapper_RichHtmlField");
        div.parent().parent().parent().siblings().each(function () {
            $(this).removeClass("ym-g33");
            $(this).addClass("ym-g50");
        });
        div.parent().parent().parent().remove();
    }
    if ($("#ctl00_PlaceHolderMain_SecondSideBarControl_SuccessStory").html() == "") {
        var div = $("#ctl00_PlaceHolderMain_SecondSideBarControl_SuccessStory");
        div.parent().parent().parent().siblings().each(function () {
            if ($(this).hasClass("ym-g33")) {
                $(this).removeClass("ym-g33");
                $(this).addClass("ym-g50");
            }
            else {
                $(this).removeClass("ym-g50");
                $(this).addClass("ym-g100");
            }       
        });
        div.parent().remove();
    }
    if ($("#ctl00_PlaceHolderMain_SecondSideBarControl_PopularControl").html() == "") {
        var div = $("#ctl00_PlaceHolderMain_SecondSideBarControl_PopularControl");
        div.parent().parent().siblings().each(function () {
            if ($(this).hasClass("ym-g33")) {
                $(this).removeClass("ym-g33");
                $(this).addClass("ym-g50");
            }
            else {
                $(this).removeClass("ym-g50");
                $(this).addClass("ym-g100");
            }
        });
        div.parent().remove();
    }

    //dodgy fix for z-index probelms with campaign menu
    if ($("body").hasClass("campaign")){
        if ($.support.leadingWhitespace) {
            $(function () {
                var zIndexNumber = 1000;
                // Put your target element(s) in the selector below!
                $("div").each(function () {
                    $(this).css('zIndex', zIndexNumber);
                    zIndexNumber -= 10;
                });
            });
        }
    
    }
    // Call to create the Coremetrics Tags


    $('.newWindow-online').click(function () {
        var win = window.open(this.href, 'new_window', 'toolbar=0,location=0, width=1024, height=768, left=10, right=0, top=10, bottom=0, scrollbars=1,directories=0,status=0,menubar=0,resizable=1');
        win.focus();
        if ($(this).parents("*[data-an-category]")[0] == undefined) {
            return false;
        }
    });
    $('.newWindow').click(function () {
        var win = window.open(this.href, 'new_window', 'toolbar=0,location=0, width=1024, height=768, left=10, right=0, top=10, bottom=0, scrollbars=1,directories=0,status=0,menubar=0,resizable=1');
        win.focus();
        if ($(this).parents("*[data-an-category]")[0] == undefined) {
            return false;
        }
    });
    $('.cm-newWindow').click(function () {
        var win = window.open(this.href + '?rl=' + encodeURIComponent(window.location.href), 'new_window', 'toolbar=0,location=0, width=1024, height=768, left=10, right=0, top=10, bottom=0, scrollbars=1,directories=0,status=0,menubar=0,resizable=1');
        win.focus();
        if ($(this).parents("*[data-an-category]")[0] == undefined) {
            return false;
        }
    });

});

function checkDate(str) {
    var m = str.match(/^(0?[1-9]|[12][0-9]|3[01])[\/\-](0?[1-9]|1[012])[\/\-]\d{4}$/);
    return m;
}


function hideEmptyStreamList() {
    if ($('#ctl00_PlaceHolderMain_VisaContentPersonaliserPanel_visaPersonaliser_divStream select option').length < 2) {
        $('#ctl00_PlaceHolderMain_VisaContentPersonaliserPanel_visaPersonaliser_divStream').hide();
    }
}

// bind top padding reset to ribbon resize event so that the page always lays out correctly.
try {
    ExecuteOrDelayUntilScriptLoaded(function () { SP.UI.Workspace.add_resized(setTopPadding); }, "init.js");
}
catch (e) { }
